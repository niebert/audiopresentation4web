<!DOCTYPE html>
<html>
  <head>
    <title>Audio Presentation for Web</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="js/linkparam.js"></script>
    <script src="js/filesaver.js"></script>
    <script src="js/canvas2blob.js"></script>
    <script src="js/dom2id.js"></script>
    <script src="js/date.js"></script>
    <script src="js/jszip.js"></script>
    <script language="javascript">
    // vDataJSON is the main JSON storage for the privacy friendly WebApp
    // File Loaded into vDataJSON by script tag
    var vDataJSON = {};
    vDataJSON.tpl = {};
    /* TEMPLATES
    vDataJSON.tpl contains the following templates:
      * vDataJSON.tpl["javascript"] File: tpl/javascript_tpl.js
        for creating the the Source Code for the UML class in javascript
      * vDataJSON.tpl["docu4github"] File: tpl/docu4github_tpl.js
        for creating the GitHub documentation from the UML source of the class
    */

    vDataJSON.out = {};
    /* HANDLEBARS COMPILERS
    vDataJSON.tpl contains the Handlebars compilers:
      * vDataJSON.out["javascript"] Compiler for template: tpl/javascript_tpl.js
        This compiler is used in the compileCode() method
        var mySource = vJSONEditor.compileCode.javascript(pJSON)
        creates the source code for the UML class in javascript
      * vDataJSON.out["docu4github"] Compiler for template: tpl/docu4github_tpl.js
        This compiler is used in the compileCode() method
        var mySource = vJSONEditor.compileCode.docu4github(pJSON)
    */
    </script>
    <!-- ### Data JSON Loaded File  ##################### -->
    <script src="db/data.js"></script>
    <!-- ### HANDLEBARS TEMPLATE  #####################
    Template ID: "audioslides"
    Template: vDataJSON["tpl"]["audioslides"]
    -->
    <script src="tpl/audioslides_tpl.js"></script>
    <script src="js/handlebars4code.js"></script>

  </head>
  <body style="margin:10px;background:#C0C0C0;font-family:Arial,Helvetica,sans-serif">

    <script>


      function el(pID) {
        var vNode = document.getElementById(pID);
        if (vNode) {
          return vNode
        } else {
          console.log("Error Node ['"+pID+"']");
          return document.getElementById("tUndefined");
        }
      };

      function callSource() {
        //var vURL = "https://"+el("sWikiLanguage").value + "." + el("sWikiDomain").value+".org/wiki/";
        //vURL += encodeURI(el("tTitle").value);
        //document.location.href=vURL;
        alert("Copy generated HTML file into your Documents folder and copy files in /images/ and /audio/");
        convert("audioslides");
        //window.open(vURL);
      };



      function callSourceZIP() {
        var vURL = "output_zip.html?"+get_link_parameter();
        //document.location.href=vURL;
        window.open(vURL);
      };

      function displaySource() {
        //var vURL = "https://"+el("sWikiLanguage").value + "." + el("sWikiDomain").value+".org/wiki/";
        //vURL += encodeURI(el("tTitle").value);
        var vURL = "output_textarea.html?"+ get_link_parameter();
        //document.location.href=vURL;
        window.open(vURL);
      };


      function parseJSON(pString) {
          var vString = pString || "{}";
          var vJSON;
          if(vString) {
            try {
                vJSON = JSON.parse(vString);
            } catch(e) {
                alert("JSON Parsing Error: "+e); // error in the above string (in this case, yes)!
            };
            if (vJSON)  {
              return vJSON
            } else {
              alert("ERROR: Could not parse JSON");
              return null
            }
          }
      }

      function getDataJSON() {
        var vJSON = vDataJSON.initdata;
        for (var id in vDOM2ID) {
          if (vDOM2ID.hasOwnProperty(id)) {
              var id4JSON = getJSONID(id);
              //vJSON["title"] = vLinkParam.getValue(vDOM2ID["tTitle"]);
              switch (id) {
                case "tFirst":
                  vJSON[id4JSON] = getInteger(el(id).value);
                break;
                case "tLast":
                  vJSON[id4JSON] = getInteger(el(id).value);
                break;
                default:
                  vJSON[id4JSON] = el(id).value;
              }
            }
        };
        vJSON = populateSlides4JSON(vJSON);
        console.log(JSON.stringify(vJSON,null,4));
        return vJSON;
      };

      function getREADME(pFolder,pFileType,pTypeID) {
        var vOut = "README "+pTypeID+"-Folder \""+pFolder+"/\"\n";

        vOut +="\nCopy all of your "+pFileType+" in this folder \""+pFolder+"/\"\n";
        vOut +="\n - /" + pFolder + "/" +
              el("t"+pTypeID+"BaseName").value +
              el("tFirst").value + "." +
              el("t"+pTypeID+"Ext").value;
        vOut += "\n - ..."
        vOut +="\n - /" + pFolder + "/" +
              el("t"+pTypeID+"BaseName").value +
              el("tLast").value + "." +
              el("t"+pTypeID+"Ext").value+"\n\n";


        return vOut;
      }

      function callSourceZIP() {
        var zip = new JSZip();
        // define
        var vBaseName = el("tFileName").value;
        vJSON = getDataJSON();
        alert("Save '"+vBaseName+".zip' and unzip.\nDisplay '"+vBaseName+".html' in your browser");
        var vOutput = Handlebars4Code.compile_code("audioslides",vJSON);
        zip.file(vBaseName+".html", vOutput);
        zip.file("README.txt", getREADME("images","image files","Image")+"\n"+getREADME("audio","audio files","Audio"));
        zip.file("images/README.txt", getREADME("images","image files","Image"));
        zip.file("audio/README.txt", getREADME("audio","audio files","Audio"));
        zip.generateAsync({type:"blob"})
          .then(function (blob) {
            saveAs(blob, vBaseName+".zip");
          });

      }

      function convert(pTplID) {
          var vTplID = pTplID || "audioslides";
          var vJSON = getDataJSON();
          var vFileName = el("tFileName").value+".html"
        	if (vJSON)  {
              var vOutput = Handlebars4Code.compile_code(vTplID,vJSON);
              // File is a Javascript Class defined in FileSaver.js
              var file = new File([vOutput], {type: "text/plain;charset=utf-8"});
              // method saveAs() is defined in FileSaver.js so import filesaver.js and blob.js to your Javascript project
              //saveAs(file,vFileName);
          } else {
              alert("ERROR: Could not parse JSON")
          }
        }

        function setTemplate(pTplID) {
          //convert(pTpl);
          el("tTemplate").value = vDataJSON.tpl[pTplID];
        }


    </script>
    <hr>
      <center>
        <h2>Audio Slides for Web</h2>
        <h3><i>based on Library: <a href="https://www.npmjs.com/package/jszip" target="_blank">jszip NPM</a></i></h3>
      </center>
    <hr>
    <center>
    <p>
      <a href="https://www.github.com/niebert/audioSlides4web" target="_blank">AudioSlides4Web</a> was created as a online altervative for <a href="https://en.wikiversity.org/wiki/PanDocElectron" target="_blank">PanDocElectron</a>.
      See <a href="https://en.wikiversity.org/wiki/PanDocElectron/AudioSlides4Web" target="_blank">AudioSlides4Web in Wikiversity</a> for further details. It is necessary to copy you audio files in the subfolder <tt>/audio/</tt> and the slides e.g. as PNG-images into the folder <tt>/images/</tt>.
      Adapt the basename of your audio files and images to the base name in the interface below.
    </p>
    <br>
    <form action="audioslide.html" target="_blank">
    <table border="1">
      <tr>
        <td>
          <b>Title</b><input type="text" id="tUndefined" value="ERROR" style="display:none">
        </td>
        <td>
          <input type="text" size="80" name="title" id="tTitle" value="My Presentation Title">
        </td>
      </tr>
      <tr>
        <td>
          <b>Course</b>
        </td>
        <td>
          <input type="text" size="80" name="course" id="tCourse" value="Ecotoxicology">
        </td>
      </tr>
      <tr>
        <td>
          <b>Author</b>
        </td>
        <td>
          <input type="text" size="80" name="author" id="tAuthor" value="My Name">
        </td>
      </tr>
      <tr>
        <td>
          <b>Date</b>
        </td>
        <td>
          <input type="text" size="80" name="date" id="tDate" value="00.00.00">
        </td>
      </tr>
      <tr style="display:none">
          <td>
            <b>Audio Slides</b>
          </td>
          <td>
            <select name="audioslide" id="sAudioSlide">
              <option value="yes">Use Player for Audio Slides</option>
              <option value="no">NO Audio Slides</option>
            </select>
          </td>
      </tr>
      <tr>
        <td>
          <b>Slide Index</b>
        </td>
        <td>
          First Index: <input type="text" size="4" name="first" id="tFirst" value="0">
          Last Index: <input type="text" size="4" name="last" id="tLast" value="40">
        </td>
      </tr>
      <tr>
        <td>
          <b>Slide Image Files</b>
        </td>
        <td>
          Basename: <tt>/images/</tt><input type="text" size="10" name="imagebasename" id="tImageBaseName" value="img">.<input type="text" size="3" name="imageext" id="tImageExt" value="png">
        </td>
      </tr>
        <tr>
        <td>
          <b>Audio Files</b>
        </td>
        <td>
          Basename: <tt>/audio/</tt><input type="text" size="10" name="audiobasename" id="tAudioBaseName" value="audio">.<input type="text" size="3" name="audioext" id="tAudioExt" value="mp3"> Type:
          <input type="text" size="4" name="audiotype" id="tAudioType" value="mpeg">
        </td>
      </tr>
      <tr>
        <td>
          <b>Filename</b>
        </td>
        <td>
          <input type="text" size="30" name="filename" id="tFileName" value="audio_slides">
        </td>
      </tr>
      <tr>
        <td>
          <b>Audio Slides:</b>
        </td>
        <td>
          <input type="button" id="bSource" value="Download Slides" onclick="callSource();return false">
          <input type="button" id="bSourceZIP" value="Get Slides ZIP" onclick="callSourceZIP();return false" -->
          <!-- input type="submit" id="bSubmit" value="Download Presentation" -->
        </td>
      </tr>

    </table>
    </form>
    </center>
    <br>
    <p>
    <div id="footer" align="center" style="font-size: 80%">
				<a href="https://en.wikiversity.org/wiki/PanDocElectron/AudioSlides4Web" target="_blank">Wikiversity:PanDocElectron/AudioSlides4Web</a><br>
				<a href="https://www.github.com/niebert/audioslides4web" target="_blank">GitHub-Repo</a> -
				2018 - Engelbert Niehaus -
				<a href="https://github.com/niebert/audioslides4web/archive/master.zip" target="_blank">Download GitHub (2018)</a><br/>
			</div>
    </p>
    <hr>
  </body>
  <script src="js/audioslides4web.js"></script>
  <script>
  //---------------------------------------
  //------READ LINKPARAMETER---------------
  //---------------------------------------
  var vLinkParam = new LinkParam();
  vLinkParam.init(document);
  //------ POPULATE JSON ------------------
  var vJSON = vDataJSON.initdata;
  for (var id in vDOM2ID) {
    if (vDOM2ID.hasOwnProperty(id)) {
      if (vLinkParam.exists(vDOM2ID[id])) {
        //el("vTitle").value = vLinkParam.getValue(vDOM2ID["tTitle"]);
        el(id).value = vLinkParam.getValue(vDOM2ID[id]);
      };
    }
  }
  el("tDate").value = getDateTime();
  </script>
</html>
