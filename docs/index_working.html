<!DOCTYPE html>
<html>
  <head>
    <title>Audio Presentation for Web</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="js/linkparam.js"></script>
    <script src="js/filesaver.js"></script>
    <script src="js/canvas2blob.js"></script>
    <script src="js/dom2id.js"></script>
    <script src="js/date_time.js"></script>
    <script src="js/jszip.js"></script>
    <script src="js/loadfile4dom.js"></script>
    <script src="js/audioslides4web.js"></script>
    <script language="javascript">
    var zip = new JSZip();
    // vDataJSON is the main JSON storage for the privacy friendly WebApp
    // File Loaded into vDataJSON by script tag
    var vDataJSON = {};
    vDataJSON.tpl = {};
    /* TEMPLATES
    vDataJSON.tpl contains the following templates:
      * vDataJSON.tpl["javascript"] File: tpl/javascript_tpl.js
        for creating the the Source Code for the UML class in javascript
      * vDataJSON.tpl["docu4github"] File: tpl/docu4github_tpl.js
        for creating the GitHub documentation from the UML source of the class
    */

    vDataJSON.out = {};
    /* HANDLEBARS COMPILERS
    vDataJSON.tpl contains the Handlebars compilers:
      * vDataJSON.out["javascript"] Compiler for template: tpl/javascript_tpl.js
        This compiler is used in the compileCode() method
        var mySource = vJSONEditor.compileCode.javascript(pJSON)
        creates the source code for the UML class in javascript
      * vDataJSON.out["docu4github"] Compiler for template: tpl/docu4github_tpl.js
        This compiler is used in the compileCode() method
        var mySource = vJSONEditor.compileCode.docu4github(pJSON)
    */
    vDataJSON.files = {
      "audio":[],
      "image":[]
    };

    //-----------------------------------------------

        function setSlideCount() {
          // get number of loaded slides
          var arr_img = vDataJSON.files.image;
          var vCount_Image = arr_img.length;

          // get number of loaded audio files
          var arr_audio = vDataJSON.files.audio.length;
          var vCount_Audio = arr_audio.length;
          // determine maximum and calc slide count
          var vSlideCount = vCount_Image;
          if (vCount_Audio > vCount_Image) {
            vSlideCount = vCount_Audio;
          };
          // check all slide numbers encoded in the filename
          var nr = 0;
          for (var i = 0; i < arr_img.length; i++) {
            nr = extract_number(arr_img[i].name,vSlideCount);
            if (nr >= vSlideCount) {
              vSlideCount = nr + 1;
            }
          }
          for (var i = 0; i < arr_audio.length; i++) {
            nr = extract_number(arr_audio[i].name,vSlideCount);
            if (nr >= vSlideCount) {
              vSlideCount = nr + 1;
            }
          }

          // the setting of tFirst as integer
          var vFirst = getInteger4DOM("tFirst");
          // set tLast = vFirst + vSlideCount - 1
          el("tLast").value = vFirst + vSlideCount - 1;
        }

    //-----------------------------------------------
    //---- LoadFile4DOM -----------------------------
    //-----------------------------------------------
    var lf4d = new LoadFile4DOM();
    var options = {
      "debug": false // if true, it will show the hidden <input type="file" ...> loaders in DOM
    };
    lf4d.init(document,options);
    //-----------------------------------------------
    //----- Create a new Loader "file2image" --------
    //-----------------------------------------------

    var file2image = lf4d.get_loader_options("addfile2image","image_thumb");
    file2image.returntype = "tag";
    file2image.width = 300;
    file2image.multiple = true;
    // Define what to do with the loaded data
    file2image.onload = function (data,err) {
      if (err) {
        // do something on error, perr contains error message
        console.error(err);
      } else {
        // do something with the file content in data e.g. store  in a HTML textarea (e.g. <textarea id="mytextarea" ...>
        console.log("CALL: file2image.onload('" + data.name + "')");
        var vNode = document.getElementById("outimage");
        if (vNode) {
          //console.log("CALL: file2image.onload('" + data.name + "'): "+JSON.stringify(data,null,4));
          var arr_img = vDataJSON.files.image;
          vNode.innerHTML = vNode.innerHTML + "<li>Slide " + extract_number(data.name,arr_img.length)+ ": <tt>" + data.name + "</tt><br>" + data.tag + "</li>";
          arr_img.push(data);
          //zip.file(data.name, data.file, {base64: true})
          setSlideCount();
        } else {
          console.error("ERROR: DOM Element 'outimage' does not exist!");
        }

      }
    };
    // create the load dialog 'file2image'
    lf4d.create_load_dialog(file2image);

    //-----------------------------------------------
    //----- Create a new Loader "file2audio" --------
    //-----------------------------------------------
    var file2audio = lf4d.get_loader_options("addfile2audio","audio");
    file2audio.returntype = "filehash";
    // Define what to do with the loaded data
    file2audio.onload = function (data,err) {
      if (err) {
        // do something on error, perr contains error message
        console.error(err);
      } else {
        // do something with the file content in data e.g. store  in a HTML textarea (e.g. <textarea id="mytextarea" ...>
        console.log("CALL: file2audio.onload('" + data.name + "')");
        var vNode = document.getElementById("outaudio");
        if (vNode) {
          //console.log("CALL: file2audio.onload('" + data.name + "'): "+JSON.stringify(data,null,4));
          var arr_audio = vDataJSON.files.audio;
          vNode.innerHTML = vNode.innerHTML + "<li>Audio " + extract_number(data.name,arr_audio.length)+ ": <tt>" + data.name + "</tt> </li>";
          arr_audio.push(data);
          setSlideCount();
          //zip.file(data.name, data.file, {base64: true})
      } else {
          console.error("ERROR: DOM Element 'outlist' does not exist!");
        }

      }
    };
    // create the load dialog 'file2audio'
    lf4d.create_load_dialog(file2audio);
    //-----------------------------------------------

    </script>
    <!-- ### Data JSON Loaded File  ##################### -->
    <script src="db/data.js"></script>
    <!-- ### HANDLEBARS TEMPLATE  #####################
    Template ID: "audioslides"
    Template: vDataJSON["tpl"]["audioslides"]
    -->
    <script src="tpl/audioslides_tpl.js"></script>
    <script src="js/handlebars4code.js"></script>

  </head>
  <body onload="lf4d.create()" style="margin:10px;background:#C0C0C0;font-family:Arial,Helvetica,sans-serif">

    <script>
      function el(pID) {
        var vNode = document.getElementById(pID);
        if (vNode) {
          return vNode
        } else {
          console.log("Error Node ['"+pID+"']");
          return document.getElementById("tUndefined");
        }
      };

      function callSource() {
        //var vURL = "https://"+el("sWikiLanguage").value + "." + el("sWikiDomain").value+".org/wiki/";
        //vURL += encodeURI(el("tTitle").value);
        //document.location.href=vURL;
        var vBaseName = el("tFileName").value;
        var vFileName = vBaseName+".html";
        vJSON = getDataJSON();
        alert("Save '"+vBaseName+".html' and create subfolder '"+el("tImageBaseName").value+"' and '"+el("tAudioBaseName").value+"'\nand store the images and audio files in the folder.\nDisplay '"+vBaseName+".html' in your browser");
        var vOutput = Handlebars4Code.compile_code("audioslides",vJSON);
        var file = new File([vOutput], {type: "text/plain;charset=utf-8"});
        saveAs(file,vFileName);
      };



      function callSourceZIP() {
        var vURL = "output_zip.html?"+get_link_parameter();
        //document.location.href=vURL;
        window.open(vURL);
      };

      function displaySource() {
        //var vURL = "https://"+el("sWikiLanguage").value + "." + el("sWikiDomain").value+".org/wiki/";
        //vURL += encodeURI(el("tTitle").value);
        var vURL = "output_textarea.html?"+ get_link_parameter();
        //document.location.href=vURL;
        window.open(vURL);
      };


      function parseJSON(pString) {
          var vString = pString || "{}";
          var vJSON;
          if(vString) {
            try {
                vJSON = JSON.parse(vString);
            } catch(e) {
                alert("JSON Parsing Error: "+e); // error in the above string (in this case, yes)!
            };
            if (vJSON)  {
              return vJSON
            } else {
              alert("ERROR: Could not parse JSON");
              return null
            }
          }
      }

      function getDataJSON() {
        var vJSON = vDataJSON.initdata;
        for (var id in vDOM2ID) {
          if (vDOM2ID.hasOwnProperty(id)) {
              var id4JSON = vDOM2ID[id];
              //vJSON["title"] = vLinkParam.getValue(vDOM2ID["tTitle"]);
              /*
              "tAudioType":"audiotype",
              "tAudioExt":"audioext",
              "tImageExt":"imageext",
              "tAudioBaseName":"audiobasename",
              "tImageBaseName":"imagebasename",
              */
              switch (id4JSON) {
                case "first":
                  vJSON[id4JSON] = getInteger4DOM(id);
                break;
                case "last":
                  vJSON[id4JSON] =  getInteger4DOM(id);
                break;
                case "audiobasename":
                  vJSON.data.audio.basename = el(id).value;
                break;
                case "audiotype":
                  vJSON.data.audio.type = el(id).value;
                break;
                case "audioext":
                  vJSON.data.audio.ext = el(id).value;
                break;
                case "imagebasename":
                  vJSON.data.image.basename = el(id).value;
                break;
                case "imageext":
                  vJSON.data.image.ext = el(id).value;
                break;
                default:
                  //console.log("vJSON."+id4JSON+"='"+el(id).value+"'");
                  //eval("vJSON."+id4JSON+"='"+el(id).value+"'");

                  vJSON[id4JSON] = el(id).value;
              };
            };
            console.log("getDataJSON:\n"+JSON.stringify(vJSON,null,4));
        };
        vJSON = populateSlides4JSON(vDOM2ID,vJSON);
        console.log(JSON.stringify(vJSON,null,4));
        return vJSON;
      };

      function getREADME(pFolder,pFileType,pTypeID) {
        var vOut = "README "+pTypeID+"-Folder \""+pFolder+"/\"\n";

        vOut +="\nCopy all of your "+pFileType+" in this folder \""+pFolder+"/\"\n";
        vOut +="\n - /" + pFolder + "/" +
              el("t"+pTypeID+"BaseName").value +
              el("tFirst").value + "." +
              el("t"+pTypeID+"Ext").value;
        vOut += "\n - ..."
        vOut +="\n - /" + pFolder + "/" +
              el("t"+pTypeID+"BaseName").value +
              el("tLast").value + "." +
              el("t"+pTypeID+"Ext").value+"\n\n";


        return vOut;
      }

      function reset_ZIP() {
        zip = new JSZip();
        el("outaudio").innerHTML = "";
        el("outimage").innerHTML = "";
        vDataJSON.files.audio = [];
        vDataJSON.files.image = [];
        console.log("Reset Uploads finalized");
      }

      function extract_number(name,nr) {
        // name = "my_audio_01.mp3"
        var name_split = name.split(".");
        // name_split[0] = "my_audio_01"
        var digits = name_split[0].replace(/[^0-9]/g,"");
        // digits = "01"
        if (digits.length > 0) {
          nr = parseInt(digits);
        };
        return nr;
      };

      function extract_extension(name,ext) {
        // name = "my_audio_01.mp3"
        var name_split = name.split(".");
        // name_split[1] = "mp3"
        if (name_split.length > 0) {
          ext = name_split[name_split.length - 1];
        };
        return ext;
      };


      function callSourceZIP() {
        // define
        var vBaseName = el("tFileName").value;
        vJSON = getDataJSON();
        alert("Save '"+vBaseName+".zip' and unzip.\nDisplay '"+vBaseName+".html' in your browser");
        zip.file("README.txt", getREADME("images","image files","Image")+"\n"+getREADME("audio","audio files","Audio"));
        zip.file("images/README.txt", getREADME("images","image files","Image"));
        zip.file("audio/README.txt", getREADME("audio","audio files","Audio"));
        //------ SAVE the loaded Audio to ZIP-------
        var vName = "audio/"+vJSON.data.audio.basename;
        var vExt = "." + vJSON.data.audio.ext;
        var vNumber = 0;
        var nr = 0;
        var fa = vDataJSON.files.audio;
        for (var i = 0; i < fa.length; i++) {
          nr = i + vJSON.first;
          nr = extract_number(fa[i].name,nr);
          vExt = vJSON.data.audio.ext;
          vExt = extract_extension(fa[i].name,vExt);
          console.log("Add Audio file to ZIP: "+vName+nr+vExt+ " File: "+vDataJSON.files.image[i]);
          zip.file(vName + nr + "." + vExt, fa[i].file, {base64: true});
        }
        //----- SAVE the loaded Images to ZIP ------
        vName = "images/"+vJSON.data.image.basename;
        vExt = "." + vJSON.data.image.ext;
        nr = 0;
        fa = vDataJSON.files.image;
        for (var i = 0; i < fa.length; i++) {
          nr = i + vJSON.first;
          nr = extract_number(fa[i].name,nr);
          vExt = vJSON.data.image.ext;
          vExt = extract_extension(fa[i].name,vExt);
          console.log("Add Image to ZIP: "+vName+nr+vExt + " File: "+vDataJSON.files.image[i]);
          zip.file(vName+nr + "." + vExt, fa[i].file, {base64: true});
        }
        var vOutput = Handlebars4Code.compile_code("audioslides",vJSON);
        zip.file(vBaseName+".html", vOutput);
        console.log("Audio Presentation '"+vBaseName+".html' added");
        zip.generateAsync({type:"blob"})
          .then(function (blob) {
            console.log("Save Blob as ZIP");
            saveAs(blob, vBaseName+".zip");
          });

      }

      function convert(pTplID) {
          var vTplID = pTplID || "audioslides";
          var vJSON = getDataJSON();
          var vFileName = el("tFileName").value+".html"
        	if (vJSON)  {
              var vOutput = Handlebars4Code.compile_code(vTplID,vJSON);
              // File is a Javascript Class defined in FileSaver.js
              var file = new File([vOutput], {type: "text/plain;charset=utf-8"});
              // method saveAs() is defined in FileSaver.js so import filesaver.js and blob.js to your Javascript project
              //saveAs(file,vFileName);
          } else {
              alert("ERROR: Could not parse JSON")
          }
        }

        function setTemplate(pTplID) {
          //convert(pTpl);
          el("tTemplate").value = vDataJSON.tpl[pTplID];
        }


    </script>
    <hr>
      <center>
        <h2>Audio Slides for Web</h2>
        <h3><i>based on Library: <a href="https://www.npmjs.com/package/jszip" target="_blank">jszip NPM</a></i></h3>
      </center>
    <hr>
    <center>
    <p>
      <a href="https://www.github.com/niebert/audioSlides4web" target="_blank">AudioSlides4Web</a> was created as a online altervative for <a href="https://en.wikiversity.org/wiki/PanDocElectron" target="_blank">PanDocElectron</a>.
      See <a href="https://en.wikiversity.org/wiki/PanDocElectron/AudioSlides4Web" target="_blank">AudioSlides4Web in Wikiversity</a> for further details. It is necessary to copy you audio files in the subfolder <tt>/audio/</tt> and the slides e.g. as PNG-images into the folder <tt>/images/</tt>.
      Adapt the basename of your audio files and images to the base name in the interface below.
    </p>
    <br>
    <form action="audioslide.html" target="_blank">
    <table border="1">
      <tr>
        <td>
          <b>Title</b><input type="text" id="tUndefined" value="ERROR" style="display:none">
        </td>
        <td>
          <input type="text" size="80" name="title" id="tTitle" value="My Presentation Title">
        </td>
      </tr>
      <tr>
        <td>
          <b>Course</b>
        </td>
        <td>
          <input type="text" size="80" name="course" id="tCourse" value="Ecotoxicology">
        </td>
      </tr>
      <tr>
        <td>
          <b>Author</b>
        </td>
        <td>
          <input type="text" size="80" name="author" id="tAuthor" value="My Name">
        </td>
      </tr>
      <tr>
        <td>
          <b>Date</b>
        </td>
        <td>
          <input type="text" size="80" name="date" id="tDate" value="00.00.00">
        </td>
      </tr>
      <tr style="display:none">
          <td>
            <b>Audio Slides</b>
          </td>
          <td>
            <select name="audioslide" id="sAudioSlide">
              <option value="yes">Use Player for Audio Slides</option>
              <option value="no">NO Audio Slides</option>
            </select>
          </td>
      </tr>
      <tr>
        <td>
          <b>Slide Index</b>
        </td>
        <td>
          First Index: <input type="text" size="4" name="first" id="tFirst" value="0">
          Last Index: <input type="text" size="4" name="last" id="tLast" value="40">
        </td>
      </tr>
      <tr>
        <td>
          <b>Slide Image Files</b>
        </td>
        <td>
          Basename: <tt>/images/</tt><input type="text" size="10" name="imagebasename" id="tImageBaseName" value="img">.<input type="text" size="3" name="imageext" id="tImageExt" value="png">
        </td>
      </tr>
        <tr>
        <td>
          <b>Audio Files</b>
        </td>
        <td>
          Basename: <tt>/audio/</tt><input type="text" size="10" name="audiobasename" id="tAudioBaseName" value="audio">.<input type="text" size="3" name="audioext" id="tAudioExt" value="mp3"> Type:
          <input type="text" size="4" name="audiotype" id="tAudioType" value="mpeg">
        </td>
      </tr>
      <tr>
        <td>
          <b>Filename</b>
        </td>
        <td>
          <input type="text" size="30" name="filename" id="tFileName" value="audio_slides">
        </td>
      </tr>
      <tr>
        <td>
          <b>Audio Slides:</b>
        </td>
        <td>
          <!--
          <input type="button" id="bSource" value="Download Slides" onclick="callSource();return false">
          -->
          <button onclick="lf4d.open_dialog('addfile2image');return false">Add Slides</button>
          <button onclick="lf4d.open_dialog('addfile2audio');return false">Add Audio </button>
          <button onclick="reset_ZIP();return false">Reset</button> -
          <input type="button" id="bSourceZIP" value="Download Audiopresentation ZIP" onclick="callSourceZIP();return false" -->
          <!-- input type="submit" id="bSubmit" value="Download Presentation" -->
        </td>
      </tr>
    </table>
    </form>

<br>

    <table border="1">
      <tr>
        <td align="center">
          <b>Added Image</b>
        </td>
        <td align="center">
          <b>Added Audio</b>
        </td>
      </tr>
      <tr>
        <td valign="top">
          <ul id="outimage">
          </ul>
        </td>
        <td valign="top">
          <ul id="outaudio">
          </ul>
        </td>
      </tr>

    </table>
  </center>
    <br>
    <p>
    <div id="footer" align="center" style="font-size: 80%">
				<a href="https://en.wikiversity.org/wiki/PanDocElectron/AudioSlides4Web" target="_blank">Wikiversity:PanDocElectron/AudioSlides4Web</a><br>
				<a href="https://www.github.com/niebert/audioslides4web" target="_blank">GitHub-Repo</a> -
				2018 - Engelbert Niehaus -
				<a href="https://github.com/niebert/audioslides4web/archive/master.zip" target="_blank">Download GitHub (2018)</a><br/>
			</div>
    </p>
    <hr>
    <script src="js/inithtml.js"></script>
    <script>
    //---------------------------------------
    //------READ LINKPARAMETER---------------
    //---------------------------------------
    var vLinkParam = new LinkParam();
    vLinkParam.init(document);
    //------ POPULATE JSON ------------------
    var vJSON = vDataJSON.initdata;
    for (var id in vDOM2ID) {
      if (vDOM2ID.hasOwnProperty(id)) {
        if (vLinkParam.exists(vDOM2ID[id])) {
          //el("vTitle").value = vLinkParam.getValue(vDOM2ID["tTitle"]);
          el(id).value = vLinkParam.getValue(vDOM2ID[id]);
        };
      }
    }
    el("tDate").value = getDateTime();
    </script>

  </body>

</html>
