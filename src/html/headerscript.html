
    <script>


      function el(pID) {
        var vNode = document.getElementById(pID);
        if (vNode) {
          return vNode
        } else {
          console.log("Error Node ['"+pID+"']");
          return document.getElementById("tUndefined");
        }
      };

      function callSource() {
        //var vURL = "https://"+el("sWikiLanguage").value + "." + el("sWikiDomain").value+".org/wiki/";
        //vURL += encodeURI(el("tTitle").value);
        //document.location.href=vURL;
        var vBaseName = el("tFileName").value;
        var vFileName = vBaseName+".html";
        vJSON = getDataJSON();
        alert("Save '"+vBaseName+".html' and create subfolder '"+el("tImageBaseName").value+"' and '"+el("tAudioBaseName").value+"'\nand store the images and audio files in the folder.\nDisplay '"+vBaseName+".html' in your browser");
        var vOutput = Handlebars4Code.compile_code("audioslides",vJSON);
        var file = new File([vOutput], {type: "text/plain;charset=utf-8"});
        saveAs(file,vFileName);
      };



      function callSourceZIP() {
        var vURL = "output_zip.html?"+get_link_parameter();
        //document.location.href=vURL;
        window.open(vURL);
      };

      function displaySource() {
        //var vURL = "https://"+el("sWikiLanguage").value + "." + el("sWikiDomain").value+".org/wiki/";
        //vURL += encodeURI(el("tTitle").value);
        var vURL = "output_textarea.html?"+ get_link_parameter();
        //document.location.href=vURL;
        window.open(vURL);
      };


      function parseJSON(pString) {
          var vString = pString || "{}";
          var vJSON;
          if(vString) {
            try {
                vJSON = JSON.parse(vString);
            } catch(e) {
                alert("JSON Parsing Error: "+e); // error in the above string (in this case, yes)!
            };
            if (vJSON)  {
              return vJSON
            } else {
              alert("ERROR: Could not parse JSON");
              return null
            }
          }
      }

      function getDataJSON() {
        var vJSON = vDataJSON.initdata;
        for (var id in vDOM2ID) {
          if (vDOM2ID.hasOwnProperty(id)) {
              var id4JSON = vDOM2ID[id];
              //vJSON["title"] = vLinkParam.getValue(vDOM2ID["tTitle"]);
              /*
              "tAudioType":"audiotype",
              "tAudioExt":"audioext",
              "tImageExt":"imageext",
              "tAudioBaseName":"audiobasename",
              "tImageBaseName":"imagebasename",
              */
              switch (id4JSON) {
                case "first":
                  vJSON[id4JSON] = getInteger4DOM(id);
                break;
                case "last":
                  vJSON[id4JSON] =  getInteger4DOM(id);
                break;
                case "audiobasename":
                  vJSON.data.audio.basename = el(id).value;
                break;
                case "audiotype":
                  vJSON.data.audio.type = el(id).value;
                break;
                case "audioext":
                  vJSON.data.audio.ext = el(id).value;
                break;
                case "imagebasename":
                  vJSON.data.image.basename = el(id).value;
                break;
                case "imageext":
                  vJSON.data.image.ext = el(id).value;
                break;
                default:
                  //console.log("vJSON."+id4JSON+"='"+el(id).value+"'");
                  //eval("vJSON."+id4JSON+"='"+el(id).value+"'");

                  vJSON[id4JSON] = el(id).value;
              };
            };
            console.log("getDataJSON:\n"+JSON.stringify(vJSON,null,4));
        };
        vJSON = populateSlides4JSON(vJSON);
        console.log(JSON.stringify(vJSON,null,4));
        return vJSON;
      };

      function getREADME(pFolder,pFileType,pTypeID) {
        var vOut = "README "+pTypeID+"-Folder \""+pFolder+"/\"\n";

        vOut +="\nCopy all of your "+pFileType+" in this folder \""+pFolder+"/\"\n";
        vOut +="\n - /" + pFolder + "/" +
              el("t"+pTypeID+"BaseName").value +
              el("tFirst").value + "." +
              el("t"+pTypeID+"Ext").value;
        vOut += "\n - ..."
        vOut +="\n - /" + pFolder + "/" +
              el("t"+pTypeID+"BaseName").value +
              el("tLast").value + "." +
              el("t"+pTypeID+"Ext").value+"\n\n";


        return vOut;
      }

      function callSourceZIP() {
        var zip = new JSZip();
        // define
        var vBaseName = el("tFileName").value;
        vJSON = getDataJSON();
        alert("Save '"+vBaseName+".zip' and unzip.\nDisplay '"+vBaseName+".html' in your browser");
        var vOutput = Handlebars4Code.compile_code("audioslides",vJSON);
        zip.file(vBaseName+".html", vOutput);
        zip.file("README.txt", getREADME("images","image files","Image")+"\n"+getREADME("audio","audio files","Audio"));
        zip.file("images/README.txt", getREADME("images","image files","Image"));
        zip.file("audio/README.txt", getREADME("audio","audio files","Audio"));
        zip.generateAsync({type:"blob"})
          .then(function (blob) {
            saveAs(blob, vBaseName+".zip");
          });

      }

      function convert(pTplID) {
          var vTplID = pTplID || "audioslides";
          var vJSON = getDataJSON();
          var vFileName = el("tFileName").value+".html"
        	if (vJSON)  {
              var vOutput = Handlebars4Code.compile_code(vTplID,vJSON);
              // File is a Javascript Class defined in FileSaver.js
              var file = new File([vOutput], {type: "text/plain;charset=utf-8"});
              // method saveAs() is defined in FileSaver.js so import filesaver.js and blob.js to your Javascript project
              //saveAs(file,vFileName);
          } else {
              alert("ERROR: Could not parse JSON")
          }
        }

        function setTemplate(pTplID) {
          //convert(pTpl);
          el("tTemplate").value = vDataJSON.tpl[pTplID];
        }


    </script>
